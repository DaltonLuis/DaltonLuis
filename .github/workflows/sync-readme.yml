name: Sync Profile README

on:
  push:
    paths: [README.md]
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        uses: cli/cli/action@v2
        with:
          version: latest

      - name: Fetch repositories
        env:
          GH_TOKEN: ${{ secrets.MyGITHUB_TOKEN_SYNC }}
        run: |
          gh api user/repos --paginate --jq '
            map(select(.fork == false and .archived == false and .full_name != "DaltonLuis/DaltonLuis")) 
            | .[] | .name' > repos.txt

      - name: Sync README
        env:
          GH_TOKEN: ${{ secrets.MyGITHUB_TOKEN_SYNC }}
        run: |
          while read repo; do
            echo "Syncing $repo..."
            gh repo clone "$repo" workdir || continue
            cd workdir
            
            # Check for README changes
            if cmp -s ../README.md README.md; then
              echo "No changes - skipping"
              cd ..
              rm -rf workdir
              continue
            fi

            cp ../README.md .
            git add README.md
            git config user.name "DaltonLuis"
            git config user.email "luisinho2dbl@gmail.com"
            git commit -m "chore: sync profile README"
            
            if ! git push; then
              echo "Creating PR..."
              branch="sync/readme-$(date +%s)"
              git checkout -b "$branch"
              git push -u origin "$branch"
              gh pr create --title "Update README" --body "Automated sync from profile" --base main
            fi
            
            cd ..
            rm -rf workdir
          done < repos.txt
