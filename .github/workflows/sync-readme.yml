- name: Sync README to all repos
  env:
    GH_TOKEN: ${{ secrets.MyGITHUB_TOKEN_SYNC }}
  run: |
      set -euo pipefail
      sudo apt-get install -y gh jq
      echo "$GH_TOKEN" | gh auth login --with-token
      
      echo "Fetching repositories..."
      repos=$(gh api --paginate /user/repos -q '.[] | select(.fork == false and .archived == false and .full_name != "DaltonLuis/DaltonLuis")')
      echo "$repos" | jq -c . > targets.json
  
      echo "Starting sync..."
      while IFS= read -r repo; do
        name=$(jq -r '.name' <<< "$repo")
        full_name=$(jq -r '.full_name' <<< "$repo")
        default_branch=$(jq -r '.default_branch' <<< "$repo")
  
        echo "Processing $full_name..."
        git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/${full_name}.git" workdir
        cd workdir
  
        if [ -f README.md ] && cmp -s ../README.md README.md; then
          echo "No changes - skipping"
          cd ..
          rm -rf workdir
          continue
        fi
  
        cp ../README.md .
        git add README.md
        git config user.name "DaltonLuis"
        git config user.email "luisinho2dbl@gmail.com"
  
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: sync profile README"
          git push origin "HEAD:$default_branch" || {
            echo "Creating PR..."
            branch="sync/readme-$(date +%s)"
            git checkout -b "$branch"
            git push origin "$branch"
            gh pr create --title "Update README" --body "Automated sync from profile" --base "$default_branch"
          }
        fi
  
        cd ..
      rm -rf workdir
    done < targets.json
